# Mission Control Production Deployment Workflow
name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: registry.digitalocean.com
  IMAGE_NAME: mission-control

jobs:
  # Run tests first
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd server && npm ci

      - name: Run linting
        run: |
          npm run lint || echo "No lint script found"
          cd server && npm run lint || echo "No server lint script found"

      - name: Run tests
        run: |
          npm test || echo "No tests configured yet"
          cd server && npm test || echo "No server tests configured yet"

      - name: Test production build locally
        run: |
          chmod +x scripts/production/test-production-locally.sh
          # Note: This would require Docker in CI, skipping for now
          echo "Production build test would run here"

  # Security scanning
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          npm audit --audit-level=high
          cd server && npm audit --audit-level=high

      - name: Scan for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # Build and deploy
  deploy:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install DigitalOcean CLI
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.IMAGE_NAME }}:latest

      - name: Push to DigitalOcean Container Registry
        run: |
          doctl registry login
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.DOCKER_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.DOCKER_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Navigate to app directory
            cd /opt/mission-control

            # Pull latest code
            git pull origin main

            # Update environment variables (if changed)
            # Note: .env.production should already be on server

            # Pull new Docker image
            doctl registry login --expiry-seconds 600
            docker pull ${{ env.DOCKER_REGISTRY }}/${{ secrets.DO_REGISTRY_NAME }}/${{ env.IMAGE_NAME }}:latest

            # Run database migrations if needed
            # ./scripts/production/migrate-to-postgresql.js

            # Deploy with zero downtime
            docker-compose -f docker-compose.production.yml up -d --no-deps app

            # Health check
            sleep 30
            curl -f http://localhost/health || exit 1

            # Clean up old images
            docker image prune -f

      - name: Run post-deployment tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/mission-control
            
            # Run production health checks
            curl -f https://${{ secrets.PRODUCTION_DOMAIN }}/health
            curl -f https://${{ secrets.PRODUCTION_DOMAIN }}/api/health

            # Run lightweight load test
            node scripts/production/load-test.js \
              --url https://${{ secrets.PRODUCTION_DOMAIN }} \
              --concurrent 5 \
              --duration 30

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: 'üöÄ Production deployment successful!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: '‚ùå Production deployment failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

# Rollback workflow (manual trigger)
  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    
    steps:
      - name: Rollback production deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/mission-control
            
            # Get previous working image
            PREVIOUS_IMAGE=$(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}" | grep mission-control | head -2 | tail -1 | awk '{print $2}')
            
            if [ -n "$PREVIOUS_IMAGE" ]; then
              echo "Rolling back to image: $PREVIOUS_IMAGE"
              
              # Update docker-compose to use previous image
              sed -i "s/:latest/:$PREVIOUS_IMAGE/g" docker-compose.production.yml
              
              # Deploy previous version
              docker-compose -f docker-compose.production.yml up -d --no-deps app
              
              # Health check
              sleep 30
              curl -f http://localhost/health || exit 1
              
              echo "Rollback completed successfully"
            else
              echo "No previous image found for rollback"
              exit 1
            fi